# `moni-kit`: ì¥ì•  ê°ì§€ ë° ëŒ€ì‘ì„ ìœ„í•œ ë¡œê·¸ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬

### "ë‚´ ì„œë²„ëŠ” ê³¼ì—° ì¥ì• ë¥¼ ë¹ ë¥´ê²Œ ê°ì§€í•˜ê³ , ì‹ ì†íˆ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆëŠ”ê°€?" ğŸ¤”

ì´ ì§ˆë¬¸ì„ ë˜ì¡Œì„ ë•Œ, ì œê°€ ë§Œë“  ì„œë²„ëŠ” ì‚¬ì‹¤ ê·¸ë‹¤ì§€ íš¨ìœ¨ì ì´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¨ìˆœíˆ **ìŠ¬ë™**ìœ¼ë¡œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³ , **í‚¤ë°”ë‚˜**ì—ì„œ ë¡œê·¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê²€ìƒ‰í•´ì•¼ë§Œ ì¥ì• ë¥¼ ì¶”ì í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ê²Œ ì–¼ë§ˆë‚˜ ë¹„íš¨ìœ¨ì ì¸ì§€, ê·¸ë•Œê¹Œì§€ëŠ” ì „í˜€ ê¹¨ë‹«ì§€ ëª»í–ˆì£ .

ê·¸ëŸ°ë° **í† ìŠ¤ ëŸ¬ë„ˆìŠ¤í•˜ì´ ì„¸ì…˜**ì„ ë“£ê³  ë‚˜ì„œ, **ì¥ì• ë¥¼ ë¹ ë¥´ê²Œ ê°ì§€í•˜ê³  ì‹ ì†íˆ ëŒ€ì‘í•  ìˆ˜ ìˆëŠ” ì„¤ê³„ê°€ ë¬´ì—‡ì¸ì§€** ì§„ì§€í•˜ê²Œ ê³ ë¯¼í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

### ë¡œê¹…ì— ê´€í•œ ë¬¸ì œ

ì¥ì• ë¥¼ ë¹ ë¥´ê²Œ ê°ì§€í•˜ê³  ëŒ€ì‘í•˜ê¸° ìœ„í•´ ë¡œê¹… ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ëŠ” ê³¼ì •ì—ì„œ, ì˜ˆìƒë³´ë‹¤ ë¡œê¹… ì‘ì—…ì´ í›¨ì”¬ ì»¤ì§€ê²Œ ë˜ì—ˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.

íŠ¹íˆ ì„œë²„ê°€ ëŠ˜ì–´ë‚ ìˆ˜ë¡ ê° ì„œë²„ì˜ ë¡œê·¸ í¬ë§·ì„ ì¼ì¼ì´ ë§ì¶”ëŠ” ì‘ì—…ì´ í•„ìš”í•´ì¡Œê³ , ê¸°ì¡´ ì„œë²„ì˜ ë¡œê·¸ í¬ë§·ì„ ë‹¤ì‹œ í™•ì¸í•˜ëŠ” ê³¼ì •ì´ ë¹„íš¨ìœ¨ì ì´ë¼ëŠ” ë¬¸ì œë„ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ë˜í•œ, ìƒˆë¡œìš´ íŒ€ì›ì´ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ ë¡œê·¸ í¬ë§·ì„ ë§¤ë²ˆ ì„¤ëª…í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ ë°˜ë³µë ê²ƒì´ê³ , ë¡œê·¸ í¬ë§·ì„ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•˜ê³  ë¶™ì—¬ë„£ëŠ” ê³¼ì •ì—ì„œ íœ´ë¨¼ ì—ëŸ¬ê°€ ë°œìƒí•  í™•ë¥ ë„ ë†’ì•„ì§ˆ ê²ƒ ì…ë‹ˆë‹¤.

### í•´ê²°ì±…: `moni-kit` ë¼ì´ë¸ŒëŸ¬ë¦¬

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ ì **`moni-kit`** ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ê·¸ ê³¼ì •ì—ì„œ **"ì†Œê·œëª¨ íŒ€ì—ì„œë„ ì¹´í”„ì¹´ì™€ ê°™ì€ ë³µì¡í•œ ì‹œìŠ¤í…œ ì—†ì´ íš¨ìœ¨ì ì¸ ë¡œê·¸ ê´€ë¦¬ë¥¼ í•  ìˆ˜ëŠ” ì—†ì„ê¹Œ?"**ë¼ëŠ” ê³ ë¯¼ì´ ìˆì—ˆìŠµë‹ˆë‹¤.

**`moni-kit`**ëŠ” ëª¨ë“  ì„œë²„ì—ì„œ ì¼ê´€ëœ ë¡œê·¸ í¬ë§·ì„ ìë™ìœ¼ë¡œ ì ìš©í•˜ë©°, ì¥ì•  ë°œìƒ ì‹œ **ë¹ ë¥´ê³  íš¨ìœ¨ì ìœ¼ë¡œ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡** ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê°œë°œìë“¤ì´ ë¡œê·¸ í¬ë§·ì„ ì¼ì¼ì´ ì„¤ì •í•˜ê±°ë‚˜ ê´€ë¦¬í•  í•„ìš” ì—†ì´, **ìë™ìœ¼ë¡œ** ì¥ì• ë¥¼ ì¶”ì í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìˆê²Œ ëìŠµë‹ˆë‹¤.

### ì•ìœ¼ë¡œì˜ ë¹„ì „

**í† ìŠ¤ ëŸ¬ë„ˆìŠ¤í•˜ì´ ì„¸ì…˜**ì—ì„œì˜ ì¤‘ìš”í•œ ì§ˆë¬¸, **"ì¥ì• ë¥¼ ë¹ ë¥´ê²Œ ê°ì§€í•˜ê³  ì‹ ì†íˆ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆëŠ”ê°€?"**ì— ëŒ€í•œ ë‹µì„ ì°¾ìœ¼ë©´ì„œ ì €ëŠ” **`moni-kit`**ì„ ë” ë§ì€ ê°œë°œìë“¤ì—ê²Œ ìœ ìš©í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´ ê¾¸ì¤€íˆ ë°œì „ì‹œì¼œ ë‚˜ê°ˆ ê²ƒì…ë‹ˆë‹¤.

### ê²°ê³¼: ë” íš¨ìœ¨ì ì´ê³  ì‹ ì†í•œ ì¥ì•  ëŒ€ì‘

ì´ì œ, ê°œë°œìë“¤ì€ **ë¡œê·¸ ì„¤ì •ì— ëŒ€í•œ ê±±ì • ì—†ì´** ì¥ì• ë¥¼ ë¹ ë¥´ê²Œ íŒŒì•…í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **ì´ê²Œ ë°”ë¡œ `moni-kit`ì˜ ì¥ì ì´ë¼ ìƒê°í•©ë‹ˆë‹¤. âœ¨

---

**`moni-kit`**ëŠ” ì¥ì• ë¥¼ ë¹ ë¥´ê²Œ ê°ì§€í•˜ê³ , ì‹ ì†íˆ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ ë¡œê·¸ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ, ì†Œê·œëª¨ íŒ€ì—ì„œë„ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.


---

## MoniKit í”„ë¡œì íŠ¸ êµ¬ì¡°

---
# í”„ë¡œì íŠ¸ êµ¬ì¡°

```
root/                       
â”‚â”€â”€ monitoring-core/          # ë¡œê¹…ì— í•„ìš”í•œ í•„ìˆ˜ ìˆœìˆ˜ ìë°” ì½”ë“œ      
â”‚â”€â”€ monitoring-starter/       # ì‹¤ì œ ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê³  ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ëŠ” êµ¬í˜„ì²´ê°€ ì œê³µ
```
---


### 1. `monitoring-core`
`monitoring-core`ëŠ” ìˆœìˆ˜ ìë°” ê°ì²´ë¡œ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°, í•µì‹¬ ì¸í„°í˜ì´ìŠ¤ì¸ `LogEntry`ì™€ `LogNotifier`ê°€ í¬í•¨ë©ë‹ˆë‹¤.


#### `LogEntry` ì¸í„°í˜ì´ìŠ¤
ëª¨ë“  ë¡œê·¸ ì—”íŠ¸ë¦¬ëŠ” `LogEntry` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ELKì™€ Prometheusì™€ ì—°ë™í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°í™”ëœ ë¡œê·¸ ë°ì´í„°ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```java
package com.monikit.core;

import java.time.Instant;

public interface LogEntry {
    Instant getTimestamp();
    String getTraceId();
    LogType getLogType();
    LogLevel getLogLevel();
    String toString();
}

```

- getTimestamp(): ë¡œê·¸ ìƒì„± ì‹œê° (UTC ê¸°ì¤€)
- getTraceId(): íŠ¸ëœì­ì…˜ì„ ì¶”ì í•˜ê¸° ìœ„í•œ ê³ ìœ  ID
- getLogType(): ë¡œê·¸ ìœ í˜• (ì˜ˆ: EXECUTION_TIME, BUSINESS_EVENT, EXCEPTION ë“±)
- getLogLevel(): ë¡œê·¸ ë ˆë²¨ (TRACE, DEBUG, INFO, WARN, ERROR)



#### `LogNotifier` ì¸í„°í˜ì´ìŠ¤
ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. **monitoring-starter** ì—ì„œ êµ¬í˜„í•˜ë©°, **monitoring-core** ëŠ” ì˜ì¡´ì„±ì„ ê°–ì§€ ì•ŠìŠµë‹ˆë‹¤.

```java
package com.monikit.core;

public interface LogNotifier {
        void notify(LogLevel logLevel, String message);
        void notify(LogEntry logEntry);
}
```

#### `MetricCollector` ì¸í„°í˜ì´ìŠ¤
HTTP ìš”ì²­ ë° SQL ì¿¼ë¦¬ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ëŠ” ê³µí†µ ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

```java
package com.monikit.core;

public interface MetricCollector {
   void recordHttpRequest(String method, String uri, int statusCode, long duration);
   void recordQueryMetrics(String sql, long executionTime, String dataSourceName);
}

```


#### `LogEntryContext` ì¸í„°í˜ì´ìŠ¤
ìŠ¤ë ˆë“œë¡œì»¬ì„ ì´ìš©í•´ ë¡œê·¸ ì—”íŠ¸ë¦¬ íë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ë¡œê·¸ê°€ ìš”ì²­ ë‹¨ìœ„ë¡œ ì €ì¥ë˜ê³  ê´€ë¦¬ë©ë‹ˆë‹¤.

```java
package com.monikit.core;

import java.util.Queue;
import java.util.concurrent.Callable;
import java.util.concurrent.ConcurrentLinkedQueue;

public class LogEntryContext {
   private static final InheritableThreadLocal<Queue<LogEntry>> logThreadLocal =
           new InheritableThreadLocal<>() {
              @Override
              protected Queue<LogEntry> initialValue() {
                 return new ConcurrentLinkedQueue<>();
              }
           };

   private static final InheritableThreadLocal<Boolean> hasError =
           new InheritableThreadLocal<>() {
              @Override
              protected Boolean initialValue() {
                 return false;
              }
           };

   // ë¡œê·¸ ì¶”ê°€
   static void addLog(LogEntry logEntry) {
      logThreadLocal.get().add(logEntry);
   }

   // ë¡œê·¸ ë°˜í™˜
   public static Queue<LogEntry> getLogs() {
      return new ConcurrentLinkedQueue<>(logThreadLocal.get());
   }

   // ìš”ì²­ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí–ˆëŠ”ì§€ ì—¬ë¶€ í™•ì¸
   public static boolean hasError() {
      return hasError.get();
   }

   // ì˜ˆì™¸ ë°œìƒ ì—¬ë¶€ ì„¤ì •
   static void setErrorOccurred(boolean errorOccurred) {
      hasError.set(errorOccurred);
   }

   // ìì‹ ìŠ¤ë ˆë“œë¡œ ì»¨í…ìŠ¤íŠ¸ ì „íŒŒ
   static Runnable propagateToChildThread(Runnable task) {
      Queue<LogEntry> parentLogs = new ConcurrentLinkedQueue<>(logThreadLocal.get());
      Boolean parentHasError = hasError.get();
      return () -> {
         logThreadLocal.set(new ConcurrentLinkedQueue<>(parentLogs));
         hasError.set(parentHasError);
         task.run();
      };
   }

   static <T> Callable<T> propagateToChildThread(Callable<T> task) {
      Queue<LogEntry> parentLogs = new ConcurrentLinkedQueue<>(logThreadLocal.get());
      Boolean parentHasError = hasError.get();
      return () -> {
         logThreadLocal.set(new ConcurrentLinkedQueue<>(parentLogs));
         hasError.set(parentHasError);
         return task.call();
      };
   }
}


```

#### `LogEntryContextManager` ì¸í„°í˜ì´ìŠ¤
**LogEntryContext**ë¥¼ ê´€ë¦¬í•˜ëŠ” ë§¤ë‹ˆì € í´ë˜ìŠ¤ì…ë‹ˆë‹¤. ë¡œê·¸ë¥¼ ì¶”ê°€í•˜ê³ , ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.


```java
package com.monikit.core;

import java.util.concurrent.Callable;

public class LogEntryContextManager {
   private static final int MAX_LOG_SIZE = 1000;
   private static LogNotifier logNotifier;

   // LogNotifier ì„¤ì •
   public static void setLogNotifier(LogNotifier notifier) {
      logNotifier = notifier;
   }

   // ë¡œê·¸ ì¶”ê°€
   public static void addLog(LogEntry logEntry) {
      if (LogEntryContext.size() >= MAX_LOG_SIZE) {
         logNotifier.notify(LogLevel.WARN, "LogEntryContext cleared due to size limit");
         flush();
         LogEntryContext.clear();
      }
      LogEntryContext.addLog(logEntry);
   }

   // ëª¨ë“  ë¡œê·¸ ì¶œë ¥ ë° ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
   public static void flush() {
      for (LogEntry log : LogEntryContext.getLogs()) {
         logNotifier.notify(log);
      }
      LogEntryContext.clear();
      LogEntryContext.setErrorOccurred(false);
   }

   // ë¶€ëª¨ ìŠ¤ë ˆë“œì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìì‹ ìŠ¤ë ˆë“œë¡œ ì „ë‹¬í•˜ëŠ” Runnable ìƒì„±
   public static Runnable propagateToChildThread(Runnable task) {
      return LogEntryContext.propagateToChildThread(task);
   }

   public static <T> Callable<T> propagateToChildThread(Callable<T> task) {
      return LogEntryContext.propagateToChildThread(task);
   }

   // ì˜ˆì™¸ ë¡œê¹…
   public static void logException(String traceId, Throwable exception) {
      if (LogEntryContext.hasError()) {
         return;
      }
      LogEntryContext.addLog(ExceptionLog.create(traceId, exception));
      LogEntryContext.setErrorOccurred(true);
   }
}

```



### 2. `monitoring-starter`
`monitoring-starter`ëŠ” **monitoring-core** ëª¨ë“ˆì— ì˜ì¡´ì„±ì„ ì£¼ì…í•˜ì—¬ ë¡œê·¸ë¥¼ ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. 
ì´ ë¶€ë¶„ì—ì„œëŠ” ì‹¤ì œ ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê³  ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ëŠ” êµ¬í˜„ì²´ê°€ ì œê³µë©ë‹ˆë‹¤.


#### `MoniKitLoggingProperties`

MoniKit ë¡œê¹… ì„¤ì •ì„ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤.

- ìƒì„¸ ë¡œê¹… ì—¬ë¶€ (`detailedLogging`)
- SQL ì¿¼ë¦¬ ì„±ëŠ¥ ë¡œê¹… ì„¤ì • (`slowQueryThresholdMs`, `criticalQueryThresholdMs`)
- ë°ì´í„°ë² ì´ìŠ¤ ë¡œê¹… í™œì„±í™” ì—¬ë¶€ (`datasourceLoggingEnabled`)

```java
package com.monikit.starter.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Configuration;

@Configuration
@ConfigurationProperties(prefix = "monikit.logging")
public class MoniKitLoggingProperties {
    private boolean detailedLogging = false;
    private long slowQueryThresholdMs = 1000;
    private long criticalQueryThresholdMs = 5000;
    private boolean datasourceLoggingEnabled = true;

    public boolean isDetailedLogging() { return detailedLogging; }
    public void setDetailedLogging(boolean detailedLogging) { this.detailedLogging = detailedLogging; }
    public long getSlowQueryThresholdMs() { return slowQueryThresholdMs; }
    public void setSlowQueryThresholdMs(long slowQueryThresholdMs) { this.slowQueryThresholdMs = slowQueryThresholdMs; }
    public long getCriticalQueryThresholdMs() { return criticalQueryThresholdMs; }
    public void setCriticalQueryThresholdMs(long criticalQueryThresholdMs) { this.criticalQueryThresholdMs = criticalQueryThresholdMs; }
    public boolean isDatasourceLoggingEnabled() { return datasourceLoggingEnabled; }
    public void setDatasourceLoggingEnabled(boolean datasourceLoggingEnabled) { this.datasourceLoggingEnabled = datasourceLoggingEnabled; }
}
```


#### `MoniKitMetricsProperties`

MoniKit ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì„¤ì •ì„ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤.

- ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™œì„±í™” ì—¬ë¶€ (enabled)

```java
package com.monikit.starter.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Configuration;

@Configuration
@ConfigurationProperties(prefix = "monikit.metrics")
public class MoniKitMetricsProperties {
   private boolean enabled = true;

   public boolean isEnabled() { return enabled; }
   public void setEnabled(boolean enabled) { this.enabled = enabled; }
}
```

#### `DataSourceLoggingConfig`

LoggingDataSourceë¥¼ ìë™ìœ¼ë¡œ ê°ì‹¸ì„œ ì ìš©í•˜ëŠ” ì„¤ì • í´ë˜ìŠ¤.

- ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™œì„±í™” ì—¬ë¶€ (enabled)

```java
package com.monikit.starter.config;

import javax.sql.DataSource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;

@Configuration
public class DataSourceLoggingConfig {

   private static final Logger logger = LoggerFactory.getLogger(DataSourceLoggingConfig.class);

   @Bean
   @Primary
   public DataSource loggingDataSource(DataSource originalDataSource) {
      logger.info("Using DataSource: {}", originalDataSource.getClass().getSimpleName());
      DataSource loggingDataSource = new LoggingDataSource(originalDataSource);
      logger.info("Wrapped DataSource with LoggingDataSource: {}", loggingDataSource.getClass().getSimpleName());

      return loggingDataSource;
   }
}
```


#### `FilterAutoConfiguration`

í•„í„°ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì„¤ì • í´ë˜ìŠ¤.

```java
package com.monikit.starter.config;

import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class FilterAutoConfiguration {

   @Bean
   public FilterRegistrationBean<TraceIdFilter> traceIdFilter() {
      FilterRegistrationBean<TraceIdFilter> registrationBean = new FilterRegistrationBean<>();
      registrationBean.setFilter(new TraceIdFilter());
      registrationBean.setOrder(1);
      registrationBean.addUrlPatterns("/*");
      return registrationBean;
   }

   @Bean
   public FilterRegistrationBean<LogContextScopeFilter> logContextScopeFilter() {
      FilterRegistrationBean<LogContextScopeFilter> registrationBean = new FilterRegistrationBean<>();
      registrationBean.setFilter(new LogContextScopeFilter());
      registrationBean.setOrder(2);
      registrationBean.addUrlPatterns("/*");
      return registrationBean;
   }

   @Bean
   public HttpMetricsFilter httpMetricsFilter(MetricCollector metricCollector) {
      return new HttpMetricsFilter(metricCollector);
   }

   @Bean
   public FilterRegistrationBean<HttpMetricsFilter> httpMetricsFilterRegistration(HttpMetricsFilter httpMetricsFilter) {
      FilterRegistrationBean<HttpMetricsFilter> registrationBean = new FilterRegistrationBean<>();
      registrationBean.setFilter(httpMetricsFilter);
      registrationBean.setOrder(3);
      registrationBean.addUrlPatterns("/*");
      return registrationBean;
   }
}

```


#### `TraceIdFilter`

ìš”ì²­ ë‹¨ìœ„ë¡œ Trace IDë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” í•„í„°.

```java
package com.monikit.starter.filter;

import java.io.IOException;
import java.util.UUID;
import org.slf4j.MDC;
import org.springframework.web.filter.OncePerRequestFilter;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

public class TraceIdFilter extends OncePerRequestFilter {

   private static final String TRACE_ID_HEADER = "X-Trace-Id";
   private static final String MDC_TRACE_ID_KEY = "traceId";

   @Override
   protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                   FilterChain filterChain) throws ServletException, IOException {
      String traceId = request.getHeader(TRACE_ID_HEADER);

      if (traceId == null || traceId.isEmpty()) {
         traceId = UUID.randomUUID().toString();
      }

      MDC.put(MDC_TRACE_ID_KEY, traceId);
      response.setHeader(TRACE_ID_HEADER, traceId);

      try {
         filterChain.doFilter(request, response);
      } finally {
         MDC.clear();
      }
   }
}

```



#### `LogContextScopeFilter`

HTTP ìš”ì²­ ë‹¨ìœ„ë¡œ LogContextScopeë¥¼ ê´€ë¦¬í•˜ëŠ” í•„í„°.

```java
package com.monikit.starter.filter;

import java.io.IOException;
import org.springframework.web.filter.OncePerRequestFilter;
import org.springframework.web.util.ContentCachingResponseWrapper;
import com.monikit.core.LogContextScope;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

public class LogContextScopeFilter extends OncePerRequestFilter {

   @Override
   protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                   FilterChain filterChain) throws ServletException, IOException {

      try (LogContextScope scope = new LogContextScope()) {
         RequestWrapper requestWrapper = new RequestWrapper(request);
         ContentCachingResponseWrapper wrappedResponse = new ContentCachingResponseWrapper(response);
         filterChain.doFilter(requestWrapper, wrappedResponse);
      }
   }
}


```



#### `HttpMetricsFilter`

HTTP ìš”ì²­ ë©”íŠ¸ë¦­ì„ Prometheusë¡œ ì „ì†¡í•˜ëŠ” í•„í„°.

```java
package com.monikit.starter.filter;

import java.io.IOException;
import org.springframework.web.filter.OncePerRequestFilter;
import com.monikit.core.MetricCollector;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

public class HttpMetricsFilter extends OncePerRequestFilter {

   private final MetricCollector metricCollector;

   public HttpMetricsFilter(MetricCollector metricCollector) {
      this.metricCollector = metricCollector;
   }

   @Override
   protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
           throws ServletException, IOException {
      long startTime = System.currentTimeMillis();
      try {
         filterChain.doFilter(request, response);
      } finally {
         long duration = System.currentTimeMillis() - startTime;
         metricCollector.recordHttpRequest(request.getMethod(), request.getRequestURI(), response.getStatus(), duration);
      }
   }
}
```



#### `InterceptorAutoConfiguration`

HTTP ì¸í„°ì…‰í„°ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì„¤ì • í´ë˜ìŠ¤.

```java
package com.monikit.starter.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
import com.monikit.starter.interceptor.HttpLoggingInterceptor;

@Configuration
public class InterceptorAutoConfiguration implements WebMvcConfigurer {

   @Bean
   public HttpLoggingInterceptor httpLoggingInterceptor() {
      return new HttpLoggingInterceptor();
   }

   @Override
   public void addInterceptors(InterceptorRegistry registry) {
      registry.addInterceptor(httpLoggingInterceptor())
              .addPathPatterns("/**");
   }
}

```

#### `HttpLoggingInterceptor`

HTTP ìš”ì²­ ë° ì‘ë‹µì„ ìë™ìœ¼ë¡œ ë¡œê¹…í•˜ëŠ” ì¸í„°ì…‰í„°.

```java
package com.monikit.starter.interceptor;

import java.io.IOException;
import java.time.Instant;
import java.util.Enumeration;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.util.ContentCachingResponseWrapper;
import com.monikit.core.HttpInboundRequestLog;
import com.monikit.core.HttpInboundResponseLog;
import com.monikit.core.LogEntryContextManager;
import com.monikit.core.LogLevel;
import com.monikit.core.TraceIdProvider;
import com.monikit.starter.filter.RequestWrapper;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@Component
public class HttpLoggingInterceptor implements HandlerInterceptor {

   private static final ThreadLocal<Instant> requestStartTime = new ThreadLocal<>();

   @Override
   public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
      String traceId = TraceIdProvider.currentTraceId();
      requestStartTime.set(Instant.now());

      LogEntryContextManager.addLog(HttpInboundRequestLog.create(
              traceId,
              request.getMethod(),
              request.getRequestURI(),
              request.getQueryString(),
              extractHeaders(request),
              extractRequestBody(request),
              request.getRemoteAddr(),
              request.getHeader("User-Agent"),
              LogLevel.INFO
      ));

      return true;
   }

   @Override
   public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws
           IOException {
      String traceId = TraceIdProvider.currentTraceId();
      Instant startTime = requestStartTime.get();
      long executionTime = startTime != null ? Instant.now().toEpochMilli() - startTime.toEpochMilli() : 0;

      LogEntryContextManager.addLog(HttpInboundResponseLog.create(
              traceId,
              request.getMethod(),
              request.getRequestURI(),
              response.getStatus(),
              extractHeaders(response),
              extractResponseBody(response),
              executionTime,
              LogLevel.INFO
      ));

      requestStartTime.remove();
   }

   private String extractHeaders(HttpServletRequest request) {
      StringBuilder headers = new StringBuilder();
      Enumeration<String> headerNames = request.getHeaderNames();
      while (headerNames.hasMoreElements()) {
         String headerName = headerNames.nextElement();
         headers.append(headerName).append(": ").append(request.getHeader(headerName)).append("; ");
      }
      return headers.toString();
   }

   private String extractHeaders(HttpServletResponse response) {
      StringBuilder headers = new StringBuilder();
      for (String headerName : response.getHeaderNames()) {
         headers.append(headerName).append(": ").append(response.getHeader(headerName)).append("; ");
      }
      return headers.toString();
   }

   private String extractRequestBody(HttpServletRequest request) {
      if (request instanceof RequestWrapper) {
         byte[] requestBody = ((RequestWrapper) request).getContentAsByteArray();
         return new String(requestBody);
      }
      return "RequestBody Can't read";
   }

   private String extractResponseBody(HttpServletResponse response) throws IOException {
      if (response instanceof ContentCachingResponseWrapper wrappedResponse) {
         byte[] contentAsByteArray = wrappedResponse.getContentAsByteArray();
         wrappedResponse.copyBodyToResponse();
         return new String(contentAsByteArray);
      }
      return "ResponseBody Can't read";
   }

}

```

## MoniKit ì„œë²„ ëª¨ë‹ˆí„°ë§ ë° ë¡œê·¸ ê´€ë¦¬ ì‹œìŠ¤í…œ

### ê¸°ëŠ¥ ì„¤ëª…

1. **ì„¤ì • ê´€ë¦¬ í´ë˜ìŠ¤**  
   `MoniKitLoggingProperties`ì™€ `MoniKitMetricsProperties`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê¹… ë° ë©”íŠ¸ë¦­ ìˆ˜ì§‘ì˜ í™œì„±í™” ì—¬ë¶€ì™€ ì„¸ë¶€ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
   - ë¡œê¹… ì„¤ì •: `detailedLogging`, `slowQueryThresholdMs`, `criticalQueryThresholdMs`, `datasourceLoggingEnabled` ë“±
   - ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì„¤ì •: `enabled` ì„¤ì •ìœ¼ë¡œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™œì„±í™”

2. **ë°ì´í„° ì†ŒìŠ¤ ë¡œê¹…**
   - `LoggingDataSource`ë¥¼ í†µí•´ ê¸°ë³¸ ë°ì´í„°ì†ŒìŠ¤ë¥¼ í”„ë¡ì‹œ ê°ì²´ë¡œ ê°ì‹¸ SQL ì¿¼ë¦¬ ì„±ëŠ¥ ë° ë°ì´í„°ë² ì´ìŠ¤ ë¡œê¹…ì„ ì§€ì›í•©ë‹ˆë‹¤.

3. **ìë™ í•„í„° ë“±ë¡**
   - ìš”ì²­ ì²˜ë¦¬ ì‹œ `TraceIdFilter`, `LogContextScopeFilter`, `HttpMetricsFilter`ê°€ ìë™ìœ¼ë¡œ ë“±ë¡ë˜ì–´ ë¡œê¹… ë° ë©”íŠ¸ë¦­ ìˆ˜ì§‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
   - **TraceIdFilter**: ìš”ì²­ë§ˆë‹¤ ê³ ìœ í•œ `TraceId`ë¥¼ ìë™ ìƒì„± ë° ê´€ë¦¬
   - **LogContextScopeFilter**: ìš”ì²­ë³„ë¡œ `LogContextScope`ë¥¼ ê´€ë¦¬í•˜ê³  ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¥¼ ë°©ì§€
   - **HttpMetricsFilter**: HTTP ìš”ì²­ì— ëŒ€í•œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ì—¬ Prometheusì™€ ê°™ì€ ì‹œìŠ¤í…œì— ì „ì†¡

4. **ì¸í„°ì…‰í„° ë“±ë¡**
   - `HttpLoggingInterceptor`ë¥¼ í†µí•´ HTTP ìš”ì²­ ë° ì‘ë‹µì„ ë¡œê¹…í•˜ê³ , `TraceId`ë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

### í–¥í›„ ê°œë°œ ê³„íš

ì§€ì†ì ìœ¼ë¡œ ê°œë°œì„ ì§„í–‰í•˜ì—¬, ELK ìŠ¤íƒê³¼ Prometheus ë˜ëŠ” ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ë¡œê·¸ì™€ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³ , ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë°ì´í„°í™”í•˜ì—¬ ì„œë²„ì˜ ê³ ë„í™” ì‘ì—…ì— ì§‘ì¤‘í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

### PR ê¸°ì—¬

ì´ í”„ë¡œì íŠ¸ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ë¡œ PR ê¸°ì—¬ë¥¼ í™˜ì˜í•©ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤~~

